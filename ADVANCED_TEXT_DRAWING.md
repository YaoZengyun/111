# 高级文字绘制功能说明

## 🎨 新增功能

已将Python脚本 `text_fit_draw.py` 的功能完整移植到安卓应用中，提供更强大的文字绘制能力。

---

## ✨ 核心特性

### 1. 自适应字号
- ✅ 自动计算最佳字体大小
- ✅ 完美适应指定矩形区域
- ✅ 支持设置最大字号限制
- ✅ 使用二分查找算法优化性能

### 2. 智能换行
- ✅ 支持中英文混合文本
- ✅ 英文按空格分词
- ✅ 中文按字符换行
- ✅ 超长单词自动拆分
- ✅ 保留段落分隔（\n）

### 3. 多色文字
- ✅ 普通文字使用默认颜色
- ✅ 中括号【】及内容使用特殊颜色
- ✅ 支持跨行中括号
- ✅ 同时支持 [] 和 【】

### 4. 灵活对齐
- ✅ 水平对齐：左对齐、居中、右对齐
- ✅ 垂直对齐：顶部、居中、底部
- ✅ 可自定义行间距

### 5. 覆盖图层
- ✅ 支持叠加透明图层（overlay.png）
- ✅ 可实现水印、边框等效果

---

## 📐 参数说明

### 文字区域设置

| 参数 | 说明 | 范围 | 默认值 |
|-----|------|------|--------|
| **X坐标** | 文字区域左上角X坐标 | 0-1000 | 100 |
| **Y坐标** | 文字区域左上角Y坐标 | 0-1000 | 100 |
| **区域宽度** | 文字绘制区域的宽度 | 1-1000 | 500 |
| **区域高度** | 文字绘制区域的高度 | 1-1000 | 200 |

### 文字样式设置

| 参数 | 说明 | 范围 | 默认值 |
|-----|------|------|--------|
| **最大字号** | 字体大小上限（自适应） | 1-100 | 40 |
| **行间距** | 行与行之间的间距比例 | 0.00-1.00 | 0.15 |
| **文字颜色** | 普通文字颜色 | 10种颜色 | 黑色 |
| **中括号颜色** | 【】及其内容颜色 | 10种颜色 | 紫色 |

---

## 🎯 使用方法

### 基础设置

1. **选择模板图片**
   - 点击"选择模板图片"
   - 选择 `base.png` 或任意图片
   - 图片将作为背景

2. **设置文字区域**
   ```
   X坐标: 100    ← 区域左边距
   Y坐标: 100    ← 区域上边距
   宽度: 500     ← 区域宽度
   高度: 200     ← 区域高度
   ```
   
   这将在图片上定义一个 500×200 的矩形区域
   起点坐标为 (100, 100)

3. **调整文字样式**
   ```
   最大字号: 40    ← 字体不会超过此大小
   行间距: 0.15    ← 行高 = 字高 × (1 + 0.15)
   ```

4. **选择颜色**
   - 点击"选择颜色" → 设置普通文字颜色
   - 长按"选择颜色" → 设置中括号颜色

### 高级功能

#### 中括号特殊颜色

在消息中使用中括号，该部分将显示为特殊颜色：

```
输入: 今天天气【很好】，心情【不错】
效果: 今天天气【很好】，心情【不错】
      ^^^^      ^^^^      ^^^^
      黑色      紫色      紫色
```

支持跨行：
```
输入: 这是一段【很长很长
的文字内容】结束
效果: 中括号内的所有文字都是紫色
```

#### 覆盖图层

1. 准备一张透明PNG图片（如logo、水印）
2. 重命名为 `overlay.png`
3. 放到应用的 `files` 目录
4. 发送消息时会自动叠加

---

## 📊 自适应原理

### 字号自适应算法

```
1. 设置字号范围: [1, min(区域高度, 最大字号)]
2. 使用二分查找:
   - 尝试字号 = (最小 + 最大) / 2
   - 根据此字号进行文本换行
   - 测量换行后的实际宽度和高度
   - 如果适应区域: 增大字号
   - 如果超出区域: 减小字号
3. 找到能完全适应区域的最大字号
```

### 文本换行算法

```
对于每个段落:
  如果包含空格:
    按空格分词
    逐词添加到当前行
    如果超出宽度: 换行
  否则:
    逐字符添加
    如果超出宽度: 换行
```

---

## 🎨 使用场景

### 场景1: 制作带评论的表情包

```
模板: base.png (表情包底图)
区域: X=50, Y=400, W=700, H=100
文字: 【我】觉得这个【很好笑】
效果: 底部居中显示，中括号部分突出
```

### 场景2: 生成文字海报

```
模板: base.png (海报背景)
区域: X=100, Y=150, W=600, H=400
文字: 这是一段较长的文字内容
     会自动换行并调整字号
     以适应指定的矩形区域
效果: 文字自适应大小，完美填充
```

### 场景3: 添加水印

```
模板: base.png (主图)
覆盖: overlay.png (半透明水印)
效果: 文字 + 水印同时显示
```

---

## 🔧 技术实现

### 核心类: TextDrawHelper.kt

```kotlin
// 主方法
TextDrawHelper.drawTextAuto(
    canvas = canvas,              // 画布
    rect = RectF(x, y, x+w, y+h), // 文字区域
    text = "要绘制的文字",
    normalColor = Color.BLACK,     // 普通颜色
    bracketColor = Color.PURPLE,   // 中括号颜色
    maxFontSize = 40,              // 最大字号
    align = Align.CENTER,          // 水平居中
    valign = VAlign.MIDDLE,        // 垂直居中
    lineSpacing = 0.15f            // 行间距
)
```

### 关键算法

1. **二分查找最佳字号**
```kotlin
while (lo <= hi) {
    val mid = (lo + hi) / 2
    if (适应区域) {
        lo = mid + 1  // 尝试更大字号
    } else {
        hi = mid - 1  // 减小字号
    }
}
```

2. **智能换行**
```kotlin
fun wrapLines(text, paint, maxWidth) {
    // 按段落、单词/字符进行换行
    // 处理超长单词
    // 保留空行
}
```

3. **多色绘制**
```kotlin
fun parseColorSegments(line) {
    // 解析 [] 和 【】
    // 生成带颜色的片段列表
    // 支持跨行
}
```

---

## 📱 操作示例

### 完整流程

1. **准备图片**
   ```
   base.png     - 背景模板（必需）
   overlay.png  - 覆盖图层（可选）
   ```

2. **应用设置**
   ```
   启用自动处理: ✓
   
   区域设置:
   X: 100, Y: 100
   宽: 500, 高: 200
   
   样式设置:
   最大字号: 40
   行间距: 0.15
   
   颜色设置:
   文字: 黑色
   括号: 紫色
   ```

3. **发送消息**
   ```
   在QQ中输入:
   "今天天气【很好】"
   
   自动处理:
   1. 检测到发送
   2. 读取文字内容
   3. 加载base.png
   4. 自适应绘制文字
   5. 叠加overlay.png
   6. 保存结果图片
   ```

---

## 🆚 对比原Python脚本

| 功能 | Python版本 | Android版本 |
|-----|-----------|------------|
| 自适应字号 | ✅ | ✅ |
| 智能换行 | ✅ | ✅ |
| 多色文字 | ✅ | ✅ |
| 水平对齐 | ✅ | ✅ |
| 垂直对齐 | ✅ | ✅ |
| 行间距 | ✅ | ✅ |
| 覆盖图层 | ✅ | ✅ |
| 中英文混排 | ✅ | ✅ |
| 段落保留 | ✅ | ✅ |

**完全实现！** 🎉

---

## 💡 使用技巧

### 技巧1: 精确定位文字区域

使用图片编辑软件（如Photoshop）打开base.png：
1. 使用矩形选框工具选择期望的文字区域
2. 查看选框的坐标和尺寸
3. 将数值填入应用设置

### 技巧2: 调整行间距

- **紧凑布局**: 0.00 - 0.10
- **舒适阅读**: 0.15 - 0.25
- **松散排版**: 0.30 - 0.50

### 技巧3: 多色搭配

建议配色方案：
```
方案1: 黑白简约
- 文字: 黑色
- 括号: 白色

方案2: 经典对比
- 文字: 黑色
- 括号: 红色

方案3: 清新风格
- 文字: 深灰
- 括号: 蓝色

方案4: 活泼风格
- 文字: 黑色
- 括号: 紫色（默认）
```

### 技巧4: 测试文字长度

先用一段测试文字：
```
短文字: "测试"
中等: "这是一段测试文字"
长文字: "这是一段很长很长的测试文字，用来检查换行效果和字号自适应"
```

观察效果，调整参数。

---

## ⚠️ 注意事项

### 1. 坐标系统
- 左上角为原点 (0, 0)
- X轴向右，Y轴向下
- 单位为像素

### 2. 区域大小
- 区域过小可能导致文字无法绘制
- 建议最小区域: 100×50
- 区域不能超出图片边界

### 3. 字号限制
- 最大字号不应超过区域高度
- 过大的字号可能导致无法适应

### 4. 性能考虑
- 文本过长会增加换行计算时间
- 建议单次消息不超过500字
- 复杂排版建议拆分多次处理

### 5. 文件命名
- 模板图片必须命名为 `template.png`
- 覆盖图层必须命名为 `overlay.png`
- 大小写敏感

---

## 🐛 常见问题

### Q1: 文字没有显示？
A: 检查：
- [ ] 文字区域是否在图片范围内
- [ ] 区域宽高是否 > 0
- [ ] 最大字号是否 > 0
- [ ] 文字颜色是否与背景色相同

### Q2: 文字被截断？
A: 
- 增大区域高度
- 减小最大字号
- 减少文字内容

### Q3: 字号太小？
A:
- 增大区域面积
- 减少文字内容
- 调高最大字号限制

### Q4: 中括号颜色没生效？
A:
- 确认使用了 [] 或 【】
- 长按"选择颜色"按钮设置括号色
- 保存设置

### Q5: 覆盖图层不显示？
A:
- 确认overlay.png存在
- 检查图片是否为透明PNG
- 确认图片大小与模板一致

---

## 📚 相关文件

```
项目文件:
├── TextDrawHelper.kt              # 核心绘制类
├── QQAccessibilityService.kt      # 服务（已更新）
├── MainActivity.kt                # 主界面（已更新）
└── activity_main.xml              # 布局（已更新）

用户文件:
├── template.png                   # 背景模板（必需）
└── overlay.png                    # 覆盖图层（可选）

文档:
├── ADVANCED_TEXT_DRAWING.md       # 本文档
├── README.md                      # 主文档
└── QUICK_START.md                 # 快速开始
```

---

## 🎉 总结

高级文字绘制功能已完全集成到安卓应用中，提供了：

✅ **自适应字号** - 自动计算最佳大小  
✅ **智能换行** - 中英文完美支持  
✅ **多色文字** - 中括号特殊显示  
✅ **灵活对齐** - 多种对齐方式  
✅ **覆盖图层** - 支持水印效果  

所有功能都经过优化，性能优秀，使用简单！

开始创作你的专属图片吧！🎨

---

**创建时间**: 2025年11月10日  
**版本**: v2.0.0  
**状态**: ✅ 完成
