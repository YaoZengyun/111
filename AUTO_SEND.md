# 自动发送功能说明

## ⚠️ 重要提示

**这是一个实验性功能**，使用前请仔细阅读本文档。

## 功能概述

自动发送功能可以在文字处理完成后，自动将生成的图片发送到QQ聊天窗口，无需手动操作。

## 工作原理

### 技术实现
使用Android无障碍服务（AccessibilityService）模拟用户操作：

```
1. 检测QQ聊天界面
   ↓
2. 查找"相册"或"+"按钮
   ↓
3. 点击按钮打开图片选择器
   ↓
4. 导航到图库界面
   ↓
5. 选择刚生成的图片
   ↓
6. 点击"发送"按钮
   ↓
7. 完成发送
```

### 多重策略
为提高成功率，采用多种查找策略：

**策略1：直接查找"相册/图片"按钮**
- 关键词：相册、图片、album、photo
- 成功率：★★★☆☆

**策略2：查找"+"按钮**
- 通过contentDescription匹配
- 成功率：★★★★☆

**策略3：延迟重试**
- 使用多个延迟时间点重试
- 延迟：500ms、800ms、1000ms
- 成功率：★★★☆☆

## 使用方法

### 开启功能

1. 打开应用主界面
2. 找到"自动发送图片"开关
3. 点击开关，会弹出警告对话框：

```
┌─────────────────────────────────┐
│  自动发送说明                    │
├─────────────────────────────────┤
│  自动发送功能使用无障碍服务模拟  │
│  点击操作：                      │
│                                 │
│  1. 点击"相册"或"+"按钮          │
│  2. 选择刚生成的图片              │
│  3. 点击"发送"按钮                │
│                                 │
│  ⚠️ 注意事项：                  │
│  • 依赖QQ界面结构，可能不稳定    │
│  • 不同QQ版本界面不同            │
│  • 如果失败，图片会保存到本地    │
│  • 建议先测试，再正式使用        │
│                                 │
│  [继续启用]  [暂不启用]         │
└─────────────────────────────────┘
```

4. 仔细阅读后，点击"继续启用"
5. 功能已开启

### 测试功能

**第一次使用前务必测试！**

1. 打开QQ，进入任意聊天
2. 在输入框输入文字（如"测试"）
3. 点击发送按钮
4. 观察是否自动发送图片

**成功标志：**
- ✅ 图片自动出现在聊天框
- ✅ 显示Toast"图片已自动发送"

**失败标志：**
- ❌ 显示Toast"自动发送失败，图片已保存"
- ❌ 图片未自动发送

### 失败处理

如果自动发送失败：

1. **查看本地图片**
   - 路径：相册 → Pictures → QQMessageImage
   - 文件名：processed_[时间戳].png

2. **手动发送**
   - 在QQ中点击"+"或"相册"
   - 找到刚保存的图片
   - 手动选择发送

3. **关闭功能**
   - 如果经常失败，建议关闭自动发送
   - 使用手动发送方式

## 兼容性说明

### 已测试版本
- QQ 8.9.x：✅ 部分支持
- QQ 9.0.x：⚠️ 待测试

### QQ版本差异

不同版本QQ界面元素可能不同：

| QQ版本 | "+"按钮 | "相册"按钮 | 兼容性 |
|--------|---------|-----------|--------|
| 8.8.x  | ✅      | ✅        | 良好   |
| 8.9.x  | ✅      | ⚠️        | 一般   |
| 9.0.x  | ⚠️      | ⚠️        | 待测试 |

### 系统要求
- Android 7.0 (API 24) 以上
- 已授予无障碍服务权限
- 已授予存储权限

## 常见问题

### Q1: 为什么自动发送总是失败？

**可能原因：**
1. QQ版本界面变化，元素ID改变
2. 无障碍服务权限未正确授予
3. QQ界面加载未完成

**解决方案：**
- 检查无障碍服务状态
- 更新到推荐QQ版本
- 发送消息前稍等片刻
- 暂时使用手动发送

### Q2: 有时成功有时失败？

**原因分析：**
- QQ界面加载速度不稳定
- 系统性能波动
- 网络延迟影响

**优化建议：**
- 不要在QQ卡顿时使用
- 确保手机性能良好
- 重要消息手动确认

### Q3: 会不会误发消息？

**安全机制：**
- ✅ 只在检测到QQ聊天界面时触发
- ✅ 只处理用户主动发送的消息
- ✅ 不会自动发送用户未输入的内容

**建议：**
- 重要对话关闭自动发送
- 发送前确认内容正确
- 可随时在主界面关闭功能

### Q4: 自动发送的是什么图片？

发送的是处理后的图片：
- 模板图片作为背景
- 你发送的文字叠加在上面
- 应用了你设置的颜色、字号、位置等

### Q5: 图片保存在哪里？

**保存位置：**
```
内部存储/Pictures/QQMessageImage/processed_[时间戳].png
```

**查看方式：**
1. 打开相册应用
2. 找到"Pictures"文件夹
3. 找到"QQMessageImageprocessed"子文件夹
4. 按时间排序查看最新图片

## 故障排除

### 检查清单

如果功能不正常，按顺序检查：

- [ ] 无障碍服务是否启用
- [ ] 存储权限是否授予
- [ ] "启用自动处理"开关是否打开
- [ ] "自动发送图片"开关是否打开
- [ ] QQ版本是否兼容
- [ ] 是否在QQ聊天界面发送消息

### 诊断步骤

**步骤1：检查权限**
```
主界面 → 查看权限状态
✓ 无障碍服务已启用
✓ 存储权限已授予
```

**步骤2：测试文字处理**
```
QQ聊天 → 发送文字 → 检查是否显示Toast
若显示"图片已处理" → 文字处理正常
```

**步骤3：检查图片保存**
```
相册 → Pictures → QQMessageImage
查看是否有新生成的图片
```

**步骤4：手动模拟操作**
```
尝试手动点击"+"→选择图片→发送
若手动可以成功 → QQ功能正常
若手动也失败 → QQ本身可能有问题
```

## 技术细节

### 代码位置
- 主要实现：`QQAccessibilityService.kt`
- 自动发送方法：`tryAutoSendImage()`
- UI控制：`MainActivity.kt`

### 关键参数
```kotlin
// 延迟时间设置（可调整）
DELAY_SHORT = 500ms   // 短延迟
DELAY_MEDIUM = 800ms  // 中延迟
DELAY_LONG = 1000ms   // 长延迟

// 查找关键词
KEYWORDS_ALBUM = ["相册", "图片", "album", "photo"]
KEYWORDS_PLUS = ["+", "添加", "add"]
```

### 调试日志
开启调试日志查看详细信息：
```kotlin
// 在 QQAccessibilityService.kt 中
private val DEBUG = true  // 设置为true启用日志

// 查看日志
adb logcat | grep "QQAccessibility"
```

## 最佳实践

### 推荐配置

**适合自动发送的场景：**
- ✅ 固定格式消息（如每日打卡）
- ✅ 重复性内容（如通知模板）
- ✅ 测试调试阶段

**不适合自动发送的场景：**
- ❌ 重要商务沟通
- ❌ 私密对话
- ❌ 需要二次确认的内容

### 使用技巧

1. **测试先行**
   - 新版本QQ发布后先测试
   - 更换模板图片后测试
   - 调整参数后测试

2. **备份方案**
   - 重要消息关闭自动发送
   - 准备手动发送的流程
   - 保存模板图片副本

3. **性能优化**
   - 不要使用过大的模板图片
   - 及时清理旧的处理图片
   - 避免在手机卡顿时使用

## 未来改进

### 计划中的功能
- [ ] 支持更多QQ版本检测
- [ ] 自适应界面结构识别
- [ ] 发送成功率统计
- [ ] 智能重试机制
- [ ] 多语言界面支持

### 已知限制
- 依赖QQ界面结构（可能随版本变化）
- 无法保证100%成功率
- 不支持Tim、QQ轻聊版等变体

## 反馈与支持

如果遇到问题或有改进建议，请：

1. 检查本文档的常见问题部分
2. 查看主要文档：README.md
3. 记录详细的错误信息和使用场景
4. 注明QQ版本、Android版本、设备型号

---

**最后提醒：** 这是实验性功能，使用需谨慎。重要消息请手动确认后再发送！
